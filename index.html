<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSD Exam Revision Dashboard | å…¬æ°‘èˆ‡ç¤¾æœƒç™¼å±•ç§‘æ¸©ç¿’å„€è¡¨æ¿</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Google Fonts: Noto Sans TC for Traditional Chinese -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Markdown Parser for AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Chosen Palette: Warm Academics -->
    <!-- 
         Background: #F9FAFB (Cool Gray 50) - Clean, paper-like.
         Primary: #1E3A8A (Blue 900) - Authoritative, academic.
         Secondary: #B45309 (Amber 700) - Highlights, important alerts.
         Text: #374151 (Gray 700) - Readable, soft black.
         Card BG: #FFFFFF (White)
    -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            light: '#E0E7FF',
                            DEFAULT: '#1E3A8A',
                            dark: '#172554',
                            accent: '#B45309',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'fade-in-up': 'fadeInUp 0.3s ease-in-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Chart Container Styles */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px; /* Max width for larger screens */
            margin-left: auto;
            margin-right: auto;
            height: 300px; /* Base height */
            max-height: 400px;
        }

        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }

        /* Hide scrollbar for clean horizontal scrolling if needed */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Chat Styles */
        .chat-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 12px;
            position: relative;
        }
        .chat-bubble-user {
            background-color: #1E3A8A;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }
        .chat-bubble-ai {
            background-color: #FFFFFF;
            border: 1px solid #E5E7EB;
            color: #374151;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #9CA3AF;
            border-radius: 50%;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* Markdown Styles within AI Chat */
        .prose p { margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .prose strong { font-weight: 600; color: #1E3A8A; }
    </style>

    <!-- Application Structure Plan: 
         1. Header: Exam Title, Countdown, NEW "Share" Button.
         2. Navigation: Tabs for Analysis, Predictions, Strategies, Checklist, AI Assistant.
         3. Content Area: Dynamic JS rendering.
         4. Share Modal: Instructions on how to host the file online.
    -->

    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-brand text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
            <div class="mb-4 md:mb-0 text-center md:text-left">
                <h1 class="text-xl md:text-2xl font-bold">å…¬æ°‘èˆ‡ç¤¾æœƒç™¼å±•ç§‘ (CSD) è€ƒè©¦æ¸©ç¿’å„€è¡¨æ¿</h1>
                <p class="text-sm text-brand-light opacity-90">Citizenship and Social Development Exam Revision Dashboard</p>
            </div>
            <div class="flex flex-col md:flex-row gap-3 items-center">
                <div class="text-center md:text-right bg-brand-dark px-4 py-2 rounded-lg shadow-inner">
                    <p class="text-xs text-gray-300 uppercase tracking-widest">ç›®æ¨™è€ƒè©¦ Target Exam</p>
                    <p class="font-bold text-lg">ä¸­å››ä¸Šå­¸æœŸ (2026å¹´1æœˆ)</p>
                </div>
                <button onclick="showShareModal()" class="bg-brand-accent hover:bg-yellow-600 text-white px-4 py-2 rounded-lg font-bold text-sm shadow transition-colors flex items-center gap-2">
                   <!-- Icon: Share -->
                   <span class="text-lg">ğŸ”—</span>
                   åˆ†äº« Share
                </button>
            </div>
        </div>
        
        <!-- Navigation -->
        <nav class="container mx-auto px-4 mt-4">
            <div class="flex space-x-1 overflow-x-auto no-scrollbar" id="nav-container">
                <!-- Nav items injected by JS -->
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main id="app-content" class="flex-grow container mx-auto px-4 py-6">
        <!-- Dynamic Content Injected Here -->
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-auto">
        <div class="container mx-auto px-4 py-6 text-center text-sm text-gray-500">
            <p>Based on 2526 T1S4CSD Exam Revision Notes & Past Paper Analysis</p>
            <p>Powered by Gemini 2.5 Flash â€¢ åŸºæ–¼ 2526 å¹´åº¦è€ƒè©¦å‚™å¿˜åŠæ­·å±†è©¦å·åˆ†æ</p>
        </div>
    </footer>

    <!-- Share Modal -->
    <div id="share-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 animate-fade-in-up">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-brand flex items-center gap-2">
                    <span>ğŸš€</span> å¦‚ä½•èˆ‡æœ‹å‹åˆ†äº«ï¼Ÿ How to Share
                </h3>
                <button onclick="hideShareModal()" class="text-gray-400 hover:text-red-500 font-bold text-xl px-2">
                    &times;
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                    <p class="font-bold text-blue-900 mb-1">æ–¹æ³• 1: ç›´æ¥å‚³é€æª”æ¡ˆ (Method 1: Send File)</p>
                    <p class="text-sm text-blue-700 leading-relaxed">é€™å€‹ç¶²é åªæ˜¯ä¸€å€‹ HTML æª”æ¡ˆã€‚ä½ å¯ä»¥ç›´æ¥æŠŠé›»è…¦ä¸Šçš„ <code>revision.html</code> æª”æ¡ˆç¶“ <strong>WhatsApp</strong>ã€<strong>AirDrop</strong> æˆ–<strong>é›»éƒµ</strong>å‚³çµ¦æœ‹å‹ã€‚ä»–å€‘æ‰“é–‹å°±èƒ½ç”¨ï¼</p>
                </div>

                <div class="bg-orange-50 p-4 rounded-lg border border-orange-100">
                    <p class="font-bold text-orange-900 mb-1">æ–¹æ³• 2: è®Šæˆç¶²å€é€£çµ (Method 2: Get a URL)</p>
                    <p class="text-sm text-orange-700 mb-2">æƒ³æœ‹å‹åªéœ€é»æ“Šé€£çµï¼Ÿæ¨è–¦ä½¿ç”¨å…è²»å·¥å…·ï¼š</p>
                    <ol class="list-decimal pl-5 text-sm text-orange-800 space-y-1">
                        <li>å‰å¾€ <strong>Tiiny.host</strong> æˆ– <strong>Netlify Drop</strong>ã€‚</li>
                        <li>å°‡ä½ çš„ <code>revision.html</code> æª”æ¡ˆæ‹–é€²å»ã€‚</li>
                        <li>å®ƒæœƒå³æ™‚çµ¦ä½ ä¸€å€‹ç¶²å€ (ä¾‹å¦‚ <code>my-csd.tiiny.site</code>)ã€‚</li>
                        <li>æŠŠç¶²å€ç™¼çµ¦æœ‹å‹å³å¯ï¼(API Key å·²å…§ç½®ï¼Œä»–å€‘ç„¡éœ€è¨­å®š)ã€‚</li>
                    </ol>
                </div>
                
                <div class="text-center mt-6">
                    <button onclick="hideShareModal()" class="bg-brand text-white hover:bg-brand-dark font-bold py-2 px-8 rounded-full transition-colors shadow-lg">
                        æ˜ç™½ Got it
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Data & Logic -->
    <script>
        // --- API CONFIGURATION ---
        const apiKey = "AIzaSyAXHHHbw6g7g8nYrS8VhDyPt6di16dI-q0"; // Key Integrated
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        
        // System Prompt for CSD Teacher Persona
        const CSD_SYSTEM_PROMPT = `
        You are a supportive and expert Hong Kong Citizenship and Social Development (CSD) teacher. 
        You are helping a Secondary 4 student revise for their Term 1 Exam based on "Theme 1: One Country, Two Systems".
        
        Crucial Syllabus Context:
        1. Constitutional Relationship: HKSAR powers come from Central Authorization (Basic Law). Constitution is the parent law.
        2. Executive & Legislative: They regulate (check) and cooperate with each other. Key examples: Budget approval, Policy Address, Questioning officials.
        3. Judicial Independence: Judges adjudicate cases independently, free from interference. Judges have immunity.
        4. National Security: "One Country" is the prerequisite for "Two Systems". Security stability leads to economic prosperity.
        5. External Affairs: HK participates in int'l orgs (like APEC, WTO) using the name "Hong Kong, China".
        
        Behavior Guidelines:
        - Be encouraging but precise with terminology.
        - Use Traditional Chinese mixed with English Key Terms.
        - If generating a quiz, ensure it is in valid JSON format.
        `;

        // --- DATA STORE ---
        const appData = {
            overview: {
                intro: {
                    zh: "æœ¬é é¢æ ¹æ“šã€Š2526 è€ƒè©¦å‚™å¿˜ã€‹åŠæ­·å±†è©¦å·åˆ†æï¼Œç‚ºä½ æä¾›æ•¸æ“šåŒ–çš„æ¸©ç¿’ç­–ç•¥ã€‚ä»¥ä¸‹åœ–è¡¨å±•ç¤ºäº†åå¤§ç†±é–€èª²é¡Œçš„å‡ºç¾é »ç‡ï¼ŒåŠ©ä½ åˆ†é…æ¸©ç¿’æ™‚é–“ã€‚",
                    en: "This page provides a data-driven revision strategy based on the '2526 Revision Notes' and past paper analysis. The charts below show the frequency of the top 10 topics to help you allocate study time."
                },
                topTopics: [
                    { rank: 1, topicZh: "è¡Œæ”¿èˆ‡ç«‹æ³•æ©Ÿé—œé—œä¿‚", topicEn: "Exec & Leg Relationship", freq: 95, label: "æ¥µé«˜ Very High" },
                    { rank: 2, topicZh: "å¸æ³•ç¨ç«‹", topicEn: "Judicial Independence", freq: 90, label: "é«˜ High" },
                    { rank: 3, topicZh: "å°å¤–äº‹å‹™é«˜åº¦è‡ªæ²»", topicEn: "External Affairs Autonomy", freq: 85, label: "é«˜ High" },
                    { rank: 4, topicZh: "ä¸€åœ‹å…©åˆ¶å„ªå‹¢", topicEn: "Benefits of 1C2S", freq: 80, label: "ä¸­é«˜ Med-High" },
                    { rank: 5, topicZh: "åœ‹å®¶å®‰å…¨èˆ‡ç©©å®š", topicEn: "National Security & Stability", freq: 70, label: "ä¸­ Medium" },
                    { rank: 6, topicZh: "ä¸­å¤®å°æ¸¯æˆæ¬Š", topicEn: "Central Authorization", freq: 65, label: "ä¸­ Medium" },
                    { rank: 7, topicZh: "æ³•æ²»æ¦‚å¿µ", topicEn: "Rule of Law Concepts", freq: 60, label: "ä¸­ Medium" },
                    { rank: 8, topicZh: "æ„›åœ‹è€…æ²»æ¸¯", topicEn: "Patriots Administering HK", freq: 55, label: "ä¸­ Medium" },
                    { rank: 9, topicZh: "å±…æ°‘æ¬Šåˆ© (ç¦åˆ©)", topicEn: "Residents' Rights (Welfare)", freq: 45, label: "ä¸­ä½ Low-Med" },
                    { rank: 10, topicZh: "æ™®é€šæ³•åˆ¶åº¦", topicEn: "Common Law System", freq: 40, label: "ä¸­ä½ Low-Med" }
                ]
            },
            predictions: {
                intro: {
                    zh: "ç¶œåˆè€ƒè©¦å‚™å¿˜çš„ã€ŒDBQ æç¤ºã€åŠéå¾€è©¦é¡Œè¶¨å‹¢ï¼Œä»¥ä¸‹æ˜¯æœ¬æ¬¡è€ƒè©¦æœ€å¯èƒ½å‡ºç¾çš„äº”å¤§èª²é¡Œã€‚",
                    en: "Combining the 'DBQ Hints' from the revision notes and past paper trends, these are the Top 5 topics most likely to appear."
                },
                items: [
                    {
                        id: 1,
                        titleZh: "æ†²åˆ¶é—œä¿‚ (DBQ é‡é»)",
                        titleEn: "Constitutional Relationship (DBQ Focus)",
                        tag: "DBQ ALERT",
                        whyZh: "è€ƒè©¦å‚™å¿˜æ˜ç¢ºæŒ‡å‡ºï¼šã€ŒDBQï¼šé‡é» 2 (åœ‹å®¶å’Œé¦™æ¸¯æ†²åˆ¶é—œä¿‚)ã€ã€‚é€™æ˜¯æœ€æ˜ç¢ºçš„è€ƒè©¦æç¤ºã€‚",
                        whyEn: "The revision notes explicitly state: 'DBQ: Focus 2'. This is the clearest hint available.",
                        studyZh: "æ¬ŠåŠ›ä¾†æº (ä¸­å¤®æˆæ¬Š)ã€æ†²æ³•èˆ‡åŸºæœ¬æ³•é—œä¿‚ (æ¯æ³•èˆ‡å­æ³•)ã€ä¸­å¤®æ“æœ‰çš„æ¬ŠåŠ› (ä»»å‘½ç‰¹é¦–ã€å¤–äº¤)ã€‚",
                        studyEn: "Source of Power (Central Authorization), Constitution vs Basic Law (Parent/Child), Central Powers (Appointing CE, Foreign Affairs)."
                    },
                    {
                        id: 2,
                        titleZh: "è¡Œæ”¿èˆ‡ç«‹æ³•æ©Ÿé—œçš„é—œä¿‚",
                        titleEn: "Executive & Legislative Relationship",
                        tag: "TREND",
                        whyZh: "é€£çºŒå…©å¹´ (23/24, 24/25) ä½œç‚º 6 åˆ†é•·é¡Œç›®å‡ºç¾ã€‚",
                        whyEn: "Appeared as a 6-mark long question in both recent years (23/24, 24/25).",
                        studyZh: "äº’ç›¸é…åˆ (å®˜å“¡åˆ—å¸­ã€é€šéæ³•æ¡ˆ) vs äº’ç›¸åˆ¶ç´„ (è³ªè©¢æ”¿åºœã€ç°½ç½²/æ‹’çµ•æ³•æ¡ˆ)ã€‚",
                        studyEn: "Cooperation (Officials attending, passing bills) vs Checks (Questioning govt, signing/refusing bills)."
                    },
                    {
                        id: 3,
                        titleZh: "å°å¤–äº‹å‹™çš„é«˜åº¦è‡ªæ²»",
                        titleEn: "High Degree of Autonomy in External Affairs",
                        tag: "RECURRING",
                        whyZh: "å…©å¹´è©¦å·å‡æœ‰å‡ºç¾ (APEC/è²¿æ˜“å”å®š)ã€‚",
                        whyEn: "Appeared in both past papers (APEC/Trade Agreements).",
                        studyZh: "å¿…é ˆè¨˜ä½ã€Œä¸­åœ‹é¦™æ¸¯ã€åç¾©ã€‚é¦™æ¸¯å¯å–®ç¨ç°½ç½²è‡ªç”±è²¿æ˜“å”å®šã€‚",
                        studyEn: "Must memorize 'Hong Kong, China'. HK can sign Free Trade Agreements independently."
                    },
                    {
                        id: 4,
                        titleZh: "å¸æ³•ç¨ç«‹",
                        titleEn: "Judicial Independence",
                        tag: "CORE",
                        whyZh: "æ³•æ²»èª²é¡Œæœ€å¸¸è€ƒæ¦‚å¿µã€‚",
                        whyEn: "Most frequently tested concept in Rule of Law.",
                        studyZh: "å¯©åˆ¤ä¸å—å¹²é ã€æ³•å®˜äº«æœ‰çš„æ³•å¾‹ä¿éšœ (å…å—èµ·è¨´)ã€‚",
                        studyEn: "Adjudicating without interference, immunity of judges."
                    },
                    {
                        id: 5,
                        titleZh: "åœ‹å®¶å®‰å…¨èˆ‡ç‡Ÿå•†ç’°å¢ƒ",
                        titleEn: "National Security & Business Env.",
                        tag: "DATA",
                        whyZh: "å¸¸èˆ‡æ•¸æ“šé¡Œçµåˆ (è³‡é‡‘æµå‘)ã€‚",
                        whyEn: "Often linked with data questions (Capital flow).",
                        studyZh: "å¼•ç”¨æ•¸æ“šè­‰æ˜åœ‹å®‰æ³•å¾Œè³‡é‡‘ç„¡æµèµ°ï¼ŒæŠ•è³‡è€…ä¿¡å¿ƒå¢åŠ  (ç©©å®š=ç¹æ¦®)ã€‚",
                        studyEn: "Cite data proving capital didn't flee after NSL, confidence increased (Stability = Prosperity)."
                    }
                ]
            },
            strategies: {
                intro: {
                    zh: "æŒæ¡å¸¸è¦‹é¡Œå‹çš„ä½œç­”æ¡†æ¶ï¼Œèƒ½æœ‰æ•ˆæå‡å¾—åˆ†ã€‚",
                    en: "Mastering the answering frameworks for common question types will effectively boost your score."
                },
                types: [
                    {
                        code: "Type A",
                        nameZh: "è³‡æ–™æ”¯æŒé¡Œ (4åˆ†)",
                        nameEn: "Data Support Question (4 marks)",
                        exampleZh: "è³‡æ–™ A å¦‚ä½•æ”¯æŒã€Œä¸€åœ‹å…©åˆ¶ä¿éšœç¹æ¦®ã€çš„çœ‹æ³•ï¼Ÿ",
                        exampleEn: "How does Source A support the view that '1C2S protects prosperity'?",
                        steps: [
                            { zh: "å¼•ç”¨æ•¸æ“š", en: "Quote Data", detailZh: "å¿…é ˆå¯«å‡ºå…·é«”æ•¸å­— (ä¾‹: ç½ªæ¡ˆè·Œ 4.5%)", detailEn: "Must write specific numbers (e.g., crime dropped 4.5%)" },
                            { zh: "è§£é‡‹è¯ç¹«", en: "Explain Link", detailZh: "è§£é‡‹æ•¸æ“šå¦‚ä½•ä»£è¡¨ç¹æ¦®/ç©©å®š", detailEn: "Explain how data represents prosperity/stability" },
                            { zh: "çµè«–", en: "Conclude", detailZh: "å› æ­¤æ”¯æŒè©²çœ‹æ³•", detailEn: "Therefore supports the view" }
                        ]
                    },
                    {
                        code: "Type B",
                        nameZh: "é—œä¿‚è§£é‡‹é¡Œ (6åˆ†)",
                        nameEn: "Relationship Explanation (6 marks)",
                        exampleZh: "è§£é‡‹è¡Œæ”¿èˆ‡ç«‹æ³•æ©Ÿé—œå¦‚ä½•äº’ç›¸åˆ¶ç´„åŠé…åˆã€‚",
                        exampleEn: "Explain how Exec & Leg organs check and cooperate.",
                        steps: [
                            { zh: "åˆ†æ®µä½œç­”", en: "Structure", detailZh: "ä¸€æ®µå¯«ã€Œé…åˆã€ï¼Œä¸€æ®µå¯«ã€Œåˆ¶ç´„ã€", detailEn: "One paragraph for 'Cooperation', one for 'Checks'" },
                            { zh: "é…åˆä¾‹å­", en: "Cooperation ex.", detailZh: "å®˜å“¡åˆ—å¸­æœƒè­°ã€è§£ç­”è³ªè©¢", detailEn: "Officials attending meetings, answering questions" },
                            { zh: "åˆ¶ç´„ä¾‹å­", en: "Checks ex.", detailZh: "ç«‹æ³•æœƒå¯©æ‰¹æ’¥æ¬¾ã€ç‰¹é¦–ç°½ç½²æ³•æ¡ˆ", detailEn: "LegCo approves funding, CE signs bills" }
                        ]
                    },
                    {
                        code: "Type C",
                        nameZh: "æ•¸æ“šæè¿°é¡Œ (4åˆ†)",
                        nameEn: "Describe Changes (4 marks)",
                        exampleZh: "æè¿°ç½ªæ¡ˆæ•¸å­—çš„å…©å€‹è®ŠåŒ–ã€‚",
                        exampleEn: "Describe two changes in crime figures.",
                        steps: [
                            { zh: "ç¸½é«”è¶¨å‹¢", en: "General Trend", detailZh: "æ•´é«”ä¸Šå‡æˆ–ä¸‹é™", detailEn: "Overall up or down" },
                            { zh: "ç‰¹æ®Šä¾‹å¤–", en: "Exception", detailZh: "æŒ‡å‡ºç›¸åçš„é …ç›® (ä¾‹: å”¯ç¨æš´åŠ›ç½ªæ¡ˆä¸Šå‡)", detailEn: "Point out opposite items (e.g., only violent crime rose)" },
                            { zh: "æ•¸æ“šè¨ˆç®—", en: "Calculation", detailZh: "å¿…é ˆè¨ˆç®—å·®é¡æˆ–ç™¾åˆ†æ¯”", detailEn: "Must calculate difference or percentage" }
                        ]
                    }
                ]
            },
            checklist: {
                intro: {
                    zh: "åŸºæ–¼ã€Š2526 è€ƒè©¦å‚™å¿˜ã€‹çš„æ¸©ç¿’æ¸…å–®ã€‚",
                    en: "Revision checklist based on '2526 Revision Notes'."
                },
                items: [
                    { id: "c1", cat: "Focus 2", textZh: "æ†²æ³•èˆ‡åŸºæœ¬æ³•çš„é—œä¿‚ (æ¯æ³•/æˆæ¬Š)", textEn: "Constitution vs Basic Law relation" },
                    { id: "c2", cat: "Focus 2", textZh: "ä¸­å¤®ç›´æ¥è¡Œä½¿çš„ä¸‰é …æ¬ŠåŠ› (å¤–äº¤/åœ‹é˜²/ä»»å‘½)", textEn: "3 Powers of Central Govt" },
                    { id: "c3", cat: "Focus 4", textZh: "è¡Œæ”¿ç«‹æ³•äº’ç›¸é…åˆä¾‹å­", textEn: "Example of Exec-Leg Cooperation" },
                    { id: "c4", cat: "Focus 4", textZh: "è¡Œæ”¿ç«‹æ³•äº’ç›¸åˆ¶ç´„ä¾‹å­", textEn: "Example of Exec-Leg Checks" },
                    { id: "c5", cat: "Focus 5", textZh: "å¸æ³•ç¨ç«‹çš„å…©å€‹ä¸»è¦å…ƒç´ ", textEn: "2 Elements of Judicial Independence" },
                    { id: "c6", cat: "Focus 1", textZh: "é¦™æ¸¯å°å¤–äº‹å‹™ä½¿ç”¨çš„åç¨± (ä¸­åœ‹é¦™æ¸¯)", textEn: "Name used in External Affairs" },
                    { id: "c7", cat: "Focus 3", textZh: "åœ‹å®¶å®‰å…¨é‡é»é ˜åŸŸ", textEn: "Key fields of National Security" }
                ]
            }
        };

        // --- STATE MANAGEMENT ---
        let currentTab = 'analysis';
        let checklistState = JSON.parse(localStorage.getItem('csdChecklist')) || {};
        let chatHistory = [];
        let isGenerating = false;

        // --- DOM ELEMENTS ---
        const navContainer = document.getElementById('nav-container');
        const appContent = document.getElementById('app-content');

        // --- NAVIGATION CONFIG ---
        const tabs = [
            { id: 'analysis', labelZh: 'æ•¸æ“šåˆ†æ', labelEn: 'Analysis' },
            { id: 'predictions', labelZh: 'å¿…è€ƒé æ¸¬', labelEn: 'Predictions' },
            { id: 'strategies', labelZh: 'ç­”é¡ŒæŠ€å·§', labelEn: 'Strategies' },
            { id: 'checklist', labelZh: 'æ¸©ç¿’æ¸…å–®', labelEn: 'Checklist' },
            { id: 'ai-assistant', labelZh: 'âœ¨ AI æº«ç¿’åŠ©æ‰‹', labelEn: 'AI Assistant' }
        ];
        
        // --- MODAL LOGIC ---
        function showShareModal() {
            const modal = document.getElementById('share-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex', 'animate-fade-in');
        }

        function hideShareModal() {
            const modal = document.getElementById('share-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex', 'animate-fade-in');
        }

        // --- GEMINI API FUNCTION ---
        async function callGemini(userPrompt, systemInstruction = CSD_SYSTEM_PROMPT) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] }
            };

            const delays = [1000, 2000, 4000, 8000, 16000];
            for (let i = 0; i < delays.length; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't generate a response.";
                } catch (error) {
                    if (i === delays.length - 1) return "Error connecting to AI service. Please try again later.";
                    await new Promise(resolve => setTimeout(resolve, delays[i]));
                }
            }
        }

        // --- RENDER FUNCTIONS ---

        function init() {
            renderNav();
            renderContent();
        }

        function renderNav() {
            navContainer.innerHTML = tabs.map(tab => `
                <button 
                    onclick="switchTab('${tab.id}')"
                    class="flex-shrink-0 px-6 py-3 rounded-t-lg font-medium transition-colors duration-200 border-b-2 
                    ${currentTab === tab.id 
                        ? 'bg-white text-brand border-brand-accent' 
                        : 'bg-brand-dark/20 text-brand-light border-transparent hover:bg-brand-dark/40'}"
                >
                    <span class="block text-sm font-bold flex items-center justify-center gap-1">
                        ${tab.labelZh}
                    </span>
                    <span class="block text-xs opacity-80">${tab.labelEn}</span>
                </button>
            `).join('');
        }

        function switchTab(tabId) {
            currentTab = tabId;
            renderNav();
            renderContent();
        }

        function renderContent() {
            appContent.innerHTML = ''; // Clear
            appContent.className = "flex-grow container mx-auto px-4 py-6 fade-in"; // Add animation

            if (currentTab === 'analysis') renderAnalysis();
            else if (currentTab === 'predictions') renderPredictions();
            else if (currentTab === 'strategies') renderStrategies();
            else if (currentTab === 'checklist') renderChecklist();
            else if (currentTab === 'ai-assistant') renderAIAssistant();
        }

        // --- VIEW: AI ASSISTANT ---
        function renderAIAssistant() {
            const html = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[80vh] lg:h-[700px]">
                    <!-- Left: Quiz Generator -->
                    <div class="bg-white rounded-xl shadow-lg border border-gray-100 flex flex-col overflow-hidden">
                        <div class="bg-gradient-to-r from-brand to-brand-light p-4 text-white">
                            <h3 class="font-bold flex items-center gap-2">
                                <span>âœ¨</span> AI è©¦é¡Œç”Ÿæˆå™¨ (Quiz Gen)
                            </h3>
                            <p class="text-xs opacity-80">Generate practice MCQs</p>
                        </div>
                        <div class="p-6 flex-grow flex flex-col gap-4 overflow-y-auto">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">é¸æ“‡èª²é¡Œ Select Topic:</label>
                                <select id="quiz-topic-select" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-brand focus:border-brand">
                                    ${appData.overview.topTopics.map(t => `<option value="${t.topicZh}">${t.topicZh} (${t.topicEn})</option>`).join('')}
                                </select>
                            </div>
                            <button onclick="generateQuiz()" id="btn-gen-quiz" class="w-full bg-brand-accent hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex justify-center items-center gap-2">
                                <span>âš¡ ç”Ÿæˆé¡Œç›® Generate</span>
                            </button>
                            
                            <!-- Quiz Display Area -->
                            <div id="quiz-display" class="hidden flex-grow flex flex-col gap-4 mt-2 border-t pt-4">
                                <!-- Quiz content injected here -->
                            </div>
                        </div>
                    </div>

                    <!-- Right: Chat Tutor -->
                    <div class="lg:col-span-2 bg-white rounded-xl shadow-lg border border-gray-100 flex flex-col overflow-hidden">
                        <div class="bg-gray-50 p-4 border-b border-gray-100 flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-brand flex items-center gap-2">
                                    <span>ğŸ’¬</span> CSD æ™ºèƒ½å°å¸« (AI Tutor)
                                </h3>
                                <p class="text-xs text-gray-500">Ask about concepts (e.g., "Explain Checks and Balances")</p>
                            </div>
                            <button onclick="clearChat()" class="text-xs text-gray-400 hover:text-red-500 underline">Clear Chat</button>
                        </div>
                        
                        <!-- Chat History -->
                        <div id="chat-history" class="flex-grow p-4 overflow-y-auto bg-gray-50/50 flex flex-col">
                            <div class="chat-bubble chat-bubble-ai">
                                <div class="prose prose-sm">
                                    ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„ CSD æº«ç¿’å°å¸«ã€‚ğŸ‘‹<br>
                                    ä½ å¯ä»¥å•æˆ‘é—œæ–¼ã€Œä¸€åœ‹å…©åˆ¶ã€ã€ã€Œæ†²æ³•èˆ‡åŸºæœ¬æ³•ã€ã€ã€Œæ”¿æ²»é«”åˆ¶ã€ç­‰å•é¡Œã€‚<br>
                                    <span class="text-xs text-gray-400 italic">Hello! Ask me anything about the CSD exam scope.</span>
                                </div>
                            </div>
                        </div>

                        <!-- Input Area -->
                        <div class="p-4 bg-white border-t border-gray-100">
                            <form onsubmit="handleChatSubmit(event)" class="flex gap-2">
                                <input type="text" id="chat-input" placeholder="å•å•é¡Œ... (e.g. ä»€éº¼æ˜¯å¸æ³•ç¨ç«‹?)" 
                                    class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-brand focus:border-transparent"
                                    autocomplete="off">
                                <button type="submit" id="btn-send-chat" class="bg-brand text-white px-6 rounded-lg font-bold hover:bg-brand-dark transition-colors disabled:opacity-50">
                                    Send
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            appContent.innerHTML = html;
        }

        // --- AI LOGIC: QUIZ GENERATOR ---
        async function generateQuiz() {
            const topic = document.getElementById('quiz-topic-select').value;
            const display = document.getElementById('quiz-display');
            const btn = document.getElementById('btn-gen-quiz');
            
            // UI Loading State
            btn.disabled = true;
            btn.innerHTML = `<span class="typing-indicator"><span></span><span></span><span></span></span> Generating...`;
            display.classList.remove('hidden');
            display.innerHTML = `<div class="animate-pulse space-y-3">
                <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                <div class="h-10 bg-gray-200 rounded"></div>
                <div class="h-10 bg-gray-200 rounded"></div>
                <div class="h-10 bg-gray-200 rounded"></div>
            </div>`;

            const prompt = `Generate one multiple-choice question (MCQ) about "${topic}" for HK CSD subject. 
            Return strictly raw JSON format (no markdown code blocks) with keys: 
            "question" (string), "options" (array of 4 strings including A/B/C/D), "answerIndex" (0-3), "explanation" (string).`;

            try {
                let text = await callGemini(prompt);
                // Clean markdown code blocks if present
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const quizData = JSON.parse(text);
                
                renderQuizCard(quizData);
            } catch (e) {
                display.innerHTML = `<p class="text-red-500 text-sm">Error generating quiz. Please try again. (${e.message})</p>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<span>âš¡ ç”Ÿæˆé¡Œç›® Generate</span>`;
            }
        }

        function renderQuizCard(data) {
            const display = document.getElementById('quiz-display');
            display.innerHTML = `
                <div class="bg-white p-4 rounded border border-gray-200 shadow-sm fade-in">
                    <p class="font-bold text-gray-800 mb-4 text-sm">${data.question}</p>
                    <div class="space-y-2">
                        ${data.options.map((opt, idx) => `
                            <button onclick="checkAnswer(${idx}, ${data.answerIndex}, '${btoa(unescape(encodeURIComponent(data.explanation)))}', this)" 
                                class="w-full text-left p-3 rounded border border-gray-200 text-sm hover:bg-gray-50 transition-colors quiz-opt-btn">
                                ${opt}
                            </button>
                        `).join('')}
                    </div>
                    <div id="quiz-feedback" class="hidden mt-4 p-3 rounded text-sm bg-gray-50 border border-gray-200"></div>
                </div>
            `;
        }

        window.checkAnswer = function(selected, correct, encodedExpl, btn) {
            const explanation = decodeURIComponent(escape(atob(encodedExpl)));
            const feedbackEl = document.getElementById('quiz-feedback');
            const allBtns = document.querySelectorAll('.quiz-opt-btn');
            
            // Disable all buttons
            allBtns.forEach(b => b.disabled = true);

            if (selected === correct) {
                btn.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                feedbackEl.innerHTML = `<p class="font-bold text-green-700">âœ… æ­£ç¢º Correct!</p><p class="mt-1 text-gray-600">${explanation}</p>`;
            } else {
                btn.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                allBtns[correct].classList.add('bg-green-50', 'border-green-500', 'text-green-800');
                feedbackEl.innerHTML = `<p class="font-bold text-red-700">âŒ éŒ¯èª¤ Wrong.</p><p class="mt-1 text-gray-600">${explanation}</p>`;
            }
            feedbackEl.classList.remove('hidden');
            feedbackEl.classList.add('fade-in');
        }

        // --- AI LOGIC: CHAT TUTOR ---
        async function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const btn = document.getElementById('btn-send-chat');
            const history = document.getElementById('chat-history');
            const userText = input.value.trim();

            if (!userText) return;

            // Add User Message
            addChatBubble(userText, 'user');
            input.value = '';
            btn.disabled = true;

            // Add Loading Bubble
            const loadingId = 'loading-' + Date.now();
            history.insertAdjacentHTML('beforeend', `
                <div id="${loadingId}" class="chat-bubble chat-bubble-ai">
                    <div class="typing-indicator"><span></span><span></span><span></span></div>
                </div>
            `);
            history.scrollTop = history.scrollHeight;

            try {
                const response = await callGemini(userText);
                document.getElementById(loadingId).remove();
                addChatBubble(response, 'ai');
            } catch (err) {
                document.getElementById(loadingId).remove();
                addChatBubble("Sorry, I encountered an error. Please try again.", 'ai');
            } finally {
                btn.disabled = false;
                // Keep focus on input for rapid chatting
                setTimeout(() => input.focus(), 100); 
            }
        }

        function addChatBubble(text, sender) {
            const history = document.getElementById('chat-history');
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble chat-bubble-${sender} fade-in`;
            
            // Parse Markdown for AI, simple text for user
            if (sender === 'ai') {
                bubble.innerHTML = `<div class="prose prose-sm max-w-none">${marked.parse(text)}</div>`;
            } else {
                bubble.innerText = text;
            }
            
            history.appendChild(bubble);
            history.scrollTop = history.scrollHeight;
        }

        window.clearChat = function() {
            const history = document.getElementById('chat-history');
            history.innerHTML = `
                <div class="chat-bubble chat-bubble-ai">
                    <div class="prose prose-sm">
                        Chat cleared. How can I help you revise now?
                    </div>
                </div>
            `;
        }

        // --- VIEW: ANALYSIS (EXISTING) ---
        function renderAnalysis() {
            const html = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Intro Card -->
                    <div class="md:col-span-3 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h2 class="text-xl font-bold text-brand mb-2">è€ƒè©¦èª²é¡Œè¶¨å‹¢åˆ†æ Analysis Overview</h2>
                        <p class="text-gray-600 mb-1">${appData.overview.intro.zh}</p>
                        <p class="text-gray-400 text-sm italic">${appData.overview.intro.en}</p>
                    </div>

                    <!-- Chart 1: Topic Frequency -->
                    <div class="md:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="text-lg font-bold text-gray-700 mb-4">åå¤§ç†±é–€èª²é¡Œé »ç‡ Top 10 Recurring Topics</h3>
                        <div class="chart-container">
                            <canvas id="topicChart"></canvas>
                        </div>
                    </div>

                    <!-- List: Top 3 Quick Look -->
                    <div class="bg-brand-light/30 p-6 rounded-xl border border-brand/10">
                        <h3 class="text-lg font-bold text-brand mb-4">å‡ºç¾é »ç‡æœ€é«˜çš„ TOP 3</h3>
                        <ul class="space-y-4">
                            ${appData.overview.topTopics.slice(0,3).map((t, idx) => `
                                <li class="bg-white p-4 rounded-lg shadow-sm border-l-4 border-brand-accent">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-bold text-2xl text-brand-accent">#${idx+1}</span>
                                        <span class="text-xs font-bold bg-brand text-white px-2 py-1 rounded-full">${t.label}</span>
                                    </div>
                                    <h4 class="font-bold text-gray-800">${t.topicZh}</h4>
                                    <p class="text-xs text-gray-500">${t.topicEn}</p>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
            `;
            appContent.innerHTML = html;
            initTopicChart();
        }

        function initTopicChart() {
            const ctx = document.getElementById('topicChart').getContext('2d');
            const topics = appData.overview.topTopics;
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: topics.map(t => t.topicZh),
                    datasets: [{
                        label: 'å‡ºç¾é »ç‡ä¼°ç®— Frequency Score',
                        data: topics.map(t => t.freq),
                        backgroundColor: topics.map(t => t.freq >= 90 ? '#B45309' : (t.freq >= 60 ? '#1E3A8A' : '#9CA3AF')),
                        borderRadius: 4,
                        barThickness: 'flex',
                        maxBarThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true, max: 100 }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.raw}% - ${topics[ctx.dataIndex].topicEn}`
                            }
                        }
                    }
                }
            });
        }

        // --- VIEW: PREDICTIONS (EXISTING) ---
        function renderPredictions() {
            const html = `
                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h2 class="text-xl font-bold text-brand mb-2">äº”å¤§å¿…è€ƒé æ¸¬ Top 5 Predictions</h2>
                        <p class="text-gray-600 mb-1">${appData.predictions.intro.zh}</p>
                        <p class="text-gray-400 text-sm italic">${appData.predictions.intro.en}</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${appData.predictions.items.map(item => `
                            <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-xl transition-shadow border-t-4 ${item.id === 1 ? 'border-brand-accent' : 'border-brand'}">
                                <div class="p-6">
                                    <div class="flex justify-between items-start mb-4">
                                        <span class="inline-block px-3 py-1 text-xs font-bold rounded-full ${item.id === 1 ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'}">
                                            ${item.tag}
                                        </span>
                                        <span class="text-gray-300 font-bold text-4xl opacity-20">0${item.id}</span>
                                    </div>
                                    
                                    <h3 class="text-lg font-bold text-gray-800 mb-1">${item.titleZh}</h3>
                                    <p class="text-xs text-gray-500 mb-4 font-medium uppercase tracking-wide">${item.titleEn}</p>
                                    
                                    <div class="space-y-4">
                                        <div>
                                            <p class="text-xs font-bold text-gray-400 uppercase mb-1">åŸå›  Why:</p>
                                            <p class="text-sm text-gray-700 leading-snug mb-1">${item.whyZh}</p>
                                            <p class="text-xs text-gray-400 italic">${item.whyEn}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-bold text-gray-400 uppercase mb-1">æº«ç¿’é‡é» Study Focus:</p>
                                            <div class="bg-gray-50 p-3 rounded text-sm text-gray-700 border-l-2 border-gray-300">
                                                <p class="mb-1 font-medium">${item.studyZh}</p>
                                                <p class="text-xs text-gray-500">${item.studyEn}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            appContent.innerHTML = html;
        }

        // --- VIEW: STRATEGIES (EXISTING) ---
        function renderStrategies() {
            const html = `
                 <div class="max-w-4xl mx-auto space-y-6">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold text-brand mb-2">å¸¸è¦‹é¡Œå‹èˆ‡ä½œç­”ç­–ç•¥</h2>
                        <p class="text-gray-600">Common Question Types & Strategies</p>
                    </div>

                    ${appData.strategies.types.map((type, idx) => `
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                            <button onclick="toggleStrategy(${idx})" class="w-full text-left p-5 flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition-colors">
                                <div>
                                    <div class="flex items-center space-x-3 mb-1">
                                        <span class="bg-brand text-white text-xs font-bold px-2 py-1 rounded">${type.code}</span>
                                        <span class="font-bold text-gray-800">${type.nameZh}</span>
                                    </div>
                                    <p class="text-xs text-gray-500 pl-11">${type.nameEn}</p>
                                </div>
                                <svg id="icon-${idx}" class="w-6 h-6 text-gray-400 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </button>
                            
                            <div id="strategy-${idx}" class="hidden border-t border-gray-100">
                                <div class="p-6">
                                    <div class="mb-6 bg-blue-50 p-4 rounded-lg">
                                        <p class="text-xs font-bold text-blue-800 uppercase mb-2">é¡Œç›®ä¾‹å­ Example Question:</p>
                                        <p class="text-sm text-blue-900 font-medium mb-1">${type.exampleZh}</p>
                                        <p class="text-xs text-blue-600 italic">${type.exampleEn}</p>
                                    </div>
                                    
                                    <h4 class="font-bold text-gray-700 mb-4 flex items-center">
                                        <span class="w-2 h-2 bg-brand-accent rounded-full mr-2"></span>
                                        ä½œç­”æ­¥é©Ÿ Answering Steps
                                    </h4>
                                    
                                    <div class="space-y-4 relative before:absolute before:inset-0 before:ml-2.5 before:-translate-x-px md:before:mx-auto md:before:translate-x-0 before:h-full before:w-0.5 before:bg-gradient-to-b before:from-transparent before:via-slate-300 before:to-transparent">
                                        ${type.steps.map((step, sIdx) => `
                                            <div class="relative flex items-center justify-between md:justify-normal md:odd:flex-row-reverse group is-active">
                                                <div class="flex items-center justify-center w-5 h-5 rounded-full border border-white bg-slate-300 group-[.is-active]:bg-brand text-white text-[10px] shadow shrink-0 md:order-1 md:group-odd:-translate-x-1/2 md:group-even:translate-x-1/2 z-10">
                                                    ${sIdx + 1}
                                                </div>
                                                <div class="w-[calc(100%-4rem)] md:w-[calc(50%-2.5rem)] bg-white p-4 rounded border border-slate-200 shadow-sm">
                                                    <div class="flex justify-between items-center mb-1">
                                                        <span class="font-bold text-gray-800 text-sm">${step.zh}</span>
                                                        <span class="text-xs text-gray-500">${step.en}</span>
                                                    </div>
                                                    <p class="text-xs text-gray-600 mt-1 pt-1 border-t border-gray-100">${step.detailZh}</p>
                                                    <p class="text-[10px] text-gray-400 mt-0.5">${step.detailEn}</p>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            appContent.innerHTML = html;
        }

        window.toggleStrategy = function(idx) {
            const content = document.getElementById(`strategy-${idx}`);
            const icon = document.getElementById(`icon-${idx}`);
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                content.classList.add('block', 'fade-in');
                icon.classList.add('rotate-180');
            } else {
                content.classList.add('hidden');
                content.classList.remove('block', 'fade-in');
                icon.classList.remove('rotate-180');
            }
        };

        // --- VIEW: CHECKLIST (EXISTING) ---
        function renderChecklist() {
            const html = `
                <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="bg-brand p-6 text-white text-center">
                        <h2 class="text-xl font-bold">æº«ç¿’é€²åº¦æ¸…å–®</h2>
                        <p class="text-sm opacity-80">Revision Checklist</p>
                        <div class="mt-4 flex justify-center items-end space-x-2">
                            <span id="progress-text" class="text-4xl font-bold text-brand-accent">0%</span>
                            <span class="text-sm mb-1">Completed</span>
                        </div>
                        <div class="w-full bg-brand-dark/30 rounded-full h-2 mt-2">
                            <div id="progress-bar" class="bg-brand-accent h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="p-2 md:p-6 divide-y divide-gray-100">
                        ${appData.checklist.items.map(item => `
                            <label class="flex items-start p-4 hover:bg-gray-50 cursor-pointer transition-colors group">
                                <div class="flex items-center h-6">
                                    <input type="checkbox" 
                                        id="${item.id}" 
                                        onchange="toggleCheck('${item.id}')"
                                        ${checklistState[item.id] ? 'checked' : ''}
                                        class="w-5 h-5 text-brand border-gray-300 rounded focus:ring-brand focus:ring-offset-0"
                                    >
                                </div>
                                <div class="ml-4 text-sm leading-6">
                                    <span class="inline-block px-2 py-0.5 text-[10px] font-bold bg-gray-100 text-gray-500 rounded mb-1">
                                        ${item.cat}
                                    </span>
                                    <p class="font-medium text-gray-900 group-hover:text-brand transition-colors ${checklistState[item.id] ? 'line-through opacity-50' : ''}" id="text-${item.id}">
                                        ${item.textZh}
                                    </p>
                                    <p class="text-gray-500 text-xs ${checklistState[item.id] ? 'line-through opacity-50' : ''}" id="sub-${item.id}">
                                        ${item.textEn}
                                    </p>
                                </div>
                            </label>
                        `).join('')}
                    </div>
                    
                    <div class="p-4 bg-gray-50 text-center">
                         <button onclick="resetChecklist()" class="text-xs text-gray-400 hover:text-red-500 underline">Reset Progress é‡ç½®é€²åº¦</button>
                    </div>
                </div>
            `;
            appContent.innerHTML = html;
            updateProgress();
        }

        window.toggleCheck = function(id) {
            checklistState[id] = !checklistState[id];
            localStorage.setItem('csdChecklist', JSON.stringify(checklistState));
            
            // UI Update for strikethrough
            const textEl = document.getElementById(`text-${id}`);
            const subEl = document.getElementById(`sub-${id}`);
            if(checklistState[id]) {
                textEl.classList.add('line-through', 'opacity-50');
                subEl.classList.add('line-through', 'opacity-50');
            } else {
                textEl.classList.remove('line-through', 'opacity-50');
                subEl.classList.remove('line-through', 'opacity-50');
            }
            
            updateProgress();
        }

        window.resetChecklist = function() {
            checklistState = {};
            localStorage.removeItem('csdChecklist');
            renderChecklist();
        }

        function updateProgress() {
            const total = appData.checklist.items.length;
            const completed = Object.values(checklistState).filter(v => v).length;
            const pct = Math.round((completed / total) * 100);
            
            document.getElementById('progress-text').innerText = `${pct}%`;
            document.getElementById('progress-bar').style.width = `${pct}%`;
        }

        // --- INIT ---
        init();

    </script>
</body>
</html>
